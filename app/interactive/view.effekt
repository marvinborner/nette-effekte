import lib/ui/view
import lib/ui/dirty
import lib/ui/node
import lib/ui/canvas
import lib/ui/vector

import app/interactive/model
import app/model

def text[Ev](content: String) = Text[Ev](content)

def button[Ev](handler: List[EventHandler[Ev]], classes: List[String], children: List[Html[Ev]]) =
  Element("button", classes, handler, children, "")

def div[Ev](handler: List[EventHandler[Ev]], classes: List[String], children: List[Html[Ev]]) =
  Element("div", classes, handler, children, "")

def div[Ev](classes: List[String], children: List[Html[Ev]]): Html[Ev] =
  div([], classes, children)

def canvas[Ev](handler: List[EventHandler[Ev]], classes: List[String], canvas: Canvas): Html[Ev] =
  Canvas(classes, handler, canvas)

def textarea[Ev](handler: List[EventHandler[Ev]], classes: List[String], text: TextStream): Html[Ev] =
  Element("textarea", classes, handler, [], collect { text() })

// ---

type Event {
  Typing(y: Bool);
  Render();
  StepReduction();
  StepAnimation();
  NextMode();
  SetSource(s: String);
  SetCanvasSize(v: Vector);
  PanCanvas(v: Vector);
  ZoomCanvas(d: Double);
}

def dispatch(msg: Event): Unit / { Model[Canvas, CanvasOp], redraw }  = msg match {
  case Typing(y)        => do typing(y)
  case Render()         => do render()
  case StepReduction()  => do stepReduction()
  case StepAnimation()  => do stepAnimation()
  case NextMode()       => do nextMode()
  case SetSource(s)     => do setSource(s)
  case SetCanvasSize(v) => do onContext(Size(v))
  case PanCanvas(v)     => do onContext(Pan(v))
  case ZoomCanvas(d)    => do onContext(Zoom(d))
}

def view(): Html[Event] / Model[Canvas, CanvasOp] = {
  div([ "grid" ], [
    div([ "menu" ], [
      text("Nette Effekte"),
      button([ OnClick(NextMode()) ], [], [ text("Current Mode: " ++ show(do getMode())) ]),
      button([ OnClick(Render())], [], [ text("Render") ]),
      button([ OnClick(StepReduction()) ], [], [ text("Step") ]),
    ]),
    div([ "split" ], [
      textarea([ OnKeyUp(box { s => SetSource(s) }), OnClick(Typing(true)) ], ["left", "code"], do getSource(do getMode())),
      canvas([
        OnResize(box { v => SetCanvasSize(v) }),
        OnDrag(box { v => PanCanvas(v) }),
        OnScroll(box { d => ZoomCanvas(d) }),
        // OnMouseDown(Typing(true)), // TODO: to prevent panning lag
        OnClick(Typing(false)),
      ], ["right", "inet"], do getContext()),
    ]),
    div([ "errors" ], [ text(do getErrors()) ]),
  ])
}

def start() = {
  style("../app/style.css")

  val appDiv = getElementById("app").getOrElse {
    val newDiv = createElement("div").setAttribute("id", "app")
    documentBody.appendChild(newDiv)
  }

  val MS_TICK = 30 // tick every n ms
  val lastTime = ref(0)

  with interactive
  run(appDiv, model::empty[NetState, Canvas, CanvasOp](), View(
    update = box { ev =>
      with interactive
      with model[Canvas, CanvasOp, Unit, NetState]
      ev.dispatch()
    },
    tick = box { timestamp =>
      with interactive
      with model[Canvas, CanvasOp, Unit, NetState]
      if (timestamp - lastTime.get > MS_TICK) {
        StepAnimation().dispatch()
        lastTime.set(timestamp)
      }
    },
    view = box {
      with interactive
      with model[Canvas, CanvasOp, Html[Event], NetState]
      view()
    }))
}